name: CI

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/ci.yml"
      - 'src/**'
      - 'Cargo.*'
      - 'flake.*'
      - 'xtask/**'
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/ci.yml"
      - 'src/**'
      - 'Cargo.*'
      - 'flake.*'
      - 'xtask/**'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.fmt

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.clippy

  check-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix develop -c cargo xtask check

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.test

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#binary-static

  summary:
    runs-on: ubuntu-latest
    needs: [fmt, clippy, check-versions, test, build]
    if: always()
    steps:
      - name: Summary
        if: always()
        run: |
          fmt="${{ needs.fmt.result }}"
          clippy="${{ needs.clippy.result }}"
          check_versions="${{ needs.check-versions.result }}"
          test="${{ needs.test.result }}"
          build="${{ needs.build.result }}"

          icon() { [[ "$1" == "success" ]] && echo "âœ…" || echo "âŒ"; }

          # Overall result
          if [[ "$fmt" == "success" && "$clippy" == "success" && "$check_versions" == "success" && "$test" == "success" && "$build" == "success" ]]; then
            header="## âœ… CI Passed"
          else
            header="## âŒ CI Failed"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ${header}

          | Check | Result |
          | --- | --- |
          | Formatting | $(icon "$fmt") \`cargo fmt\` |
          | Linting | $(icon "$clippy") \`cargo clippy\` |
          | Versioning | $(icon "$check_versions") \`cargo xtask check\` |
          | Tests | $(icon "$test") \`cargo test\` |
          | Build | $(icon "$build") \`static musl binary\` |

          EOF

          # Add failure hints
          if [[ "$fmt" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix formatting

          ```bash
          cargo fmt
          ```

          EOF
          fi

          if [[ "$clippy" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix clippy warnings

          ```bash
          cargo clippy --all-targets -- -D warnings
          ```

          EOF
          fi

          if [[ "$check_versions" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix check versions warnings

          ```bash
          cargo xtask check
          ```

          EOF
          fi

          if [[ "$test" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix tests

          ```bash
          cargo test
          ```

          EOF
          fi

          if [[ "$build" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix build

          ```bash
          nix build .#binary-static
          ```

          EOF
          fi

          # Final pass or fail.
          [[ \
            "$fmt" == "success" && \
            "$clippy" == "success" && \
            "$check_versions" == "success" && \
            "$test" == "success" && \
            "$build" == "success" \
          ]]
