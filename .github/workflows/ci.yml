name: CI

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/ci.yml"
      - 'src/**'
      - 'Cargo.*'
      - 'flake.*'
      - 'xtask/**'
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/ci.yml"
      - 'src/**'
      - 'Cargo.*'
      - 'flake.*'
      - 'xtask/**'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.fmt

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.clippy

  check-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix develop -c cargo xtask check

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#checks.x86_64-linux.test

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}
      - run: nix build .#binary-static

  summary:
    runs-on: ubuntu-latest
    needs: [fmt, clippy, check-versions, test, build]
    if: always()
    steps:
      - name: Summary
        if: always()
        run: |
          fmt="${{ needs.fmt.result }}"
          clippy="${{ needs.clippy.result }}"
          check_versions="${{ needs.check-versions.result }}"
          test="${{ needs.test.result }}"
          build="${{ needs.build.result }}"

          icon() { [[ "$1" == "success" ]] && echo "âœ…" || echo "âŒ"; }

          # Overall result
          if [[ "$fmt" == "success" && "$clippy" == "success" && "$check_versions" == "success" && "$test" == "success" && "$build" == "success" ]]; then
            header="## âœ… CI Passed"
          else
            header="## âŒ CI Failed"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ${header}

          | Check | Result |
          | --- | --- |
          | Formatting | $(icon "$fmt") \`cargo fmt\` |
          | Linting | $(icon "$clippy") \`cargo clippy\` |
          | Versioning | $(icon "$check_versions") \`cargo xtask check\` |
          | Tests | $(icon "$test") \`cargo test\` |
          | Build | $(icon "$build") \`static musl binary\` |

          EOF

          # Add failure hints
          if [[ "$fmt" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix formatting

          ```bash
          cargo fmt
          ```

          EOF
          fi

          if [[ "$clippy" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix clippy warnings

          ```bash
          cargo clippy --all-targets -- -D warnings
          ```

          EOF
          fi

          if [[ "$check_versions" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix check versions warnings

          ```bash
          cargo xtask check
          ```

          EOF
          fi

          if [[ "$test" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix tests

          ```bash
          cargo test
          ```

          EOF
          fi

          if [[ "$build" != "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### ðŸ”§ Fix build

          ```bash
          nix build .#binary-static
          ```

          EOF
          fi

          # Final pass or fail.
          [[ \
            "$fmt" == "success" && \
            "$clippy" == "success" && \
            "$check_versions" == "success" && \
            "$test" == "success" && \
            "$build" == "success" \
          ]]

  detect-release:
    runs-on: ubuntu-latest
    needs: [summary]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.summary.result == 'success'
    outputs:
      is_release: ${{ steps.detect.outputs.is_release }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Detect release commit
        id: detect
        run: |
          # check-versions job (earlier in CI) guarantees all version files are consistent,
          # so we only need to check if the version changed in one file
          PREV=$(git show HEAD~1:Cargo.toml | grep '^version = ' | cut -d'"' -f2)
          CURR=$(grep '^version = ' Cargo.toml | cut -d'"' -f2)
          if [ "$PREV" != "$CURR" ]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "version=${CURR}" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

  tag-and-release:
    runs-on: ubuntu-latest
    needs: [detect-release]
    if: needs.detect-release.outputs.is_release == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Create git tag
        env:
          TAG: v${{ needs.detect-release.outputs.version }}
        run: |
          if git ls-remote --tags origin "$TAG" | grep -qF "refs/tags/$TAG";
          then
            echo "Tag $TAG already exists, skipping."
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore Nix cache
        uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/Cargo.lock', 'flake.lock') }}

      - name: Build release image
        run: nix build .#image

      - name: Push release image
        id: push
        env:
          VERSION: ${{ needs.detect-release.outputs.version }}
        run: |
          IMAGE="quay.io/upgrades/k8s-cloud-tagger"
          TAG="${VERSION}"

          nix develop -c skopeo login quay.io \
            -u "${{ secrets.QUAY_USERNAME }}" \
            -p "${{ secrets.QUAY_PASSWORD }}"

          nix develop -c skopeo copy docker-archive:result "docker://${IMAGE}:${TAG}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## Release ${{ needs.detect-release.outputs.version }}

          | | |
          | --- | --- |
          | **Image** | \`${{ steps.push.outputs.image }}\` |
          | **Tag** | \`${{ steps.push.outputs.tag }}\` |
          | **Registry** | [Quay.io](https://quay.io/repository/upgrades/k8s-cloud-tagger?tab=tags) |
          EOF